var operational_transformation=function(){function a(a,b,c){f(typeof a=="number"&&a>=0,"the first parameter to the the parent revision number of the document"),this.revision=a,this.id=b||h(),f(this.id&&typeof this.id=="string","not a valid id: "+this.id),this.ops=c||[],this.baseLength=0,this.targetLength=0}function b(a,b){if(a.length!==b.baseLength)throw new Error("The operation's base length must be equal to the string's length.");var c=[],d=0,e=0,f=b.ops;for(var g=0,h=f.length;g<h;g++){var i=f[g];if(i.retain){if(e+i.retain>a.length)throw new Error("Operation can't retain more characters than are left in the string.");c[d++]=a.slice(e,e+i.retain),e+=i.retain}else if(i.insert)c[d++]=i.insert;else{if(i.delete!==a.slice(e,e+i.delete.length))throw new Error("The deleted string and the next characters in the string don't match.");e+=i.delete.length}}if(e!==a.length)throw new Error("The operation didn't operate on the whole string.");return c.join("")}function c(b){var c=new a(b.revision+1),d=b.ops;for(var e=0,f=d.length;e<f;e++){var g=d[e];g.retain?c.retain(g.retain):g.insert?c.delete(g.insert):c.insert(g.delete)}return c}function d(b,c){if(b.targetLength!==c.baseLength)throw new Error("The base length of the second operation has two be the target length of the first operation");if(b.revision+1!==c.revision)throw new Error("The second operations revision must be one more than the first operations revision");var d=new a(b.revision),e=b.ops,f=c.ops,g=0,h=0,i=e[g++],j=f[h++];for(;;){var k=i&&(i.retain||(i.insert||i.delete).length),l=j&&(j.retain||(j.insert||j.delete).length),m=Math.min(k,l);if(typeof i=="undefined"&&typeof j=="undefined")break;if(typeof i=="undefined"){if(!j.insert)throw new Error("Successive operations can only insert new characters at the end of the string.");d.insert(j.insert),j=f[h++]}else if(typeof j=="undefined"){if(!i.delete)throw new Error("The first operation can only delete at the end of operation 2.");d.delete(i.delete),i=e[g++]}else if(i.retain&&j.retain)k>l?(d.retain(l),i={retain:k-l},j=f[h++]):k===l?(d.retain(k),i=e[g++],j=f[h++]):(d.retain(k),i=e[g++],j={retain:l-k});else if(i.insert&&j.delete){if(i.insert.slice(0,m)!==j.delete.slice(0,m))throw new Error("Successive operations must delete what has been inserted before.");k>l?(i={insert:i.insert.slice(l)},j=f[h++]):k===l?(i=e[g++],j=f[h++]):(i=e[g++],j={"delete":j.delete.slice(k)})}else if(i.insert&&j.retain)k>l?(d.insert(i.insert.slice(0,l)),i={insert:i.insert.slice(l)},j=f[h++]):k===l?(d.insert(i.insert),i=e[g++],j=f[h++]):(d.insert(i.insert),i=e[g++],j={retain:l-k});else if(i.retain&&j.delete)k>l?(d.delete(j.delete),i={retain:k-l},j=f[h++]):k===l?(d.delete(j.delete),i=e[g++],j=f[h++]):(d.delete(j.delete.slice(0,k)),i=e[g++],j={"delete":j.delete.slice(k)});else if(i.delete)d.delete(i.delete),i=e[g++];else{if(!j.insert)throw new Error("This shouldn't happen: op1: "+JSON.stringify(i)+", op2: "+JSON.stringify(j));d.insert(j.insert),j=f[h++]}}return d}function e(b,c){if(b.baseLength!==c.baseLength)throw new Error("Both operations have to have the same base length");if(b.revision!==c.revision)throw new Error("Both operations have to have the same revision");var d=new a(c.revision+1,b.id),e=new a(b.revision+1,c.id),f=b.ops,g=c.ops,h=0,i=0,j=f[h++],k=g[i++];for(;;){var l=j&&(j.retain||(j.insert||j.delete).length),m=k&&(k.retain||(k.insert||k.delete).length),n=Math.min(l,m);if(typeof j=="undefined"&&typeof k=="undefined")break;if(j&&j.insert)d.insert(j.insert),e.retain(j.insert.length),j=f[h++];else if(k&&k.insert)d.retain(k.insert.length),e.insert(k.insert),k=g[i++];else if(j.retain&&k.retain)d.retain(n),e.retain(n),l>m?(j={retain:l-m},k=g[i++]):l===m?(j=f[h++],k=g[i++]):(j=f[h++],k={retain:m-l});else if(j.delete&&k.delete){if(j.delete.slice(0,n)!==k.delete.slice(0,n))throw new Error("When two concurrent operations delete text at the same position, they must delete the same text");l>m?(j={"delete":j.delete.slice(m)},k=g[i++]):l===m?(j=f[h++],k=g[i++]):(j=f[h++],k={"delete":k.delete.slice(l)})}else if(j.delete&&k.retain)d.delete(j.delete.slice(0,n)),l>m?(j={"delete":j.delete.slice(m)},k=g[i++]):l===m?(j=f[h++],k=g[i++]):(j=f[h++],k={retain:k.retain-l});else{if(!j.retain||!k.delete)throw new Error("The two operations aren't compatible");e.delete(k.delete.slice(0,n)),l>m?(j={retain:j.retain-m},k=g[i++]):l===m?(j=f[h++],k=g[i++]):(j=f[h++],k={"delete":k.delete.slice(l)})}}return[d,e]}function f(a,b){if(!a)throw new Error(b||"assertion error")}function g(a){return Math.floor(Math.random()*a)}function h(){var a="",b=16;while(b--)a+=g(16).toString(16);return a}return a.prototype.retain=function(a){f(typeof a=="number"&&a>=0);if(a===0)return this;this.baseLength+=a,this.targetLength+=a;var b=this.ops[this.ops.length-1];return b&&b.retain?b.retain+=a:this.ops.push({retain:a}),this},a.prototype.insert=function(a){f(typeof a=="string");if(a==="")return this;this.targetLength+=a.length;var b=this.ops[this.ops.length-1];return b&&b.insert?b.insert+=a:this.ops.push({insert:a}),this},a.prototype.delete=function(a){f(typeof a=="string");if(a==="")return this;this.baseLength+=a.length;var b=this.ops[this.ops.length-1];return b&&b.delete?b.delete+=a:this.ops.push({"delete":a}),this},a.prototype.toString=function(){var a=Array.prototype.map||function(a){var b=this,c=[];for(var d=0,e=b.length;d<e;d++)c[d]=a(b[d]);return c};return a.call(this.ops,function(a){return a.retain?"retain "+a.retain:a.insert?"insert '"+a.insert+"'":"delete '"+a.delete+"'"}).join(", ")},a.fromJSON=function(b){f(b.id);var c=new a(b.revision,b.id),d=b.ops;for(var e=0,g=d.length;e<g;e++){var h=d[e];if(h.retain)c.retain(h.retain);else if(h.insert)c.insert(h.insert);else{if(!h.delete)throw new Error("unknown operation: "+JSON.stringify(h));c.delete(h.delete)}}return f(c.baseLength===b.baseLength),f(c.targetLength===b.targetLength),c},{Operation:a,apply:b,invert:c,compose:d,transform:e}}();typeof module=="object"&&(module.exports=operational_transformation);var ot_client=function(a){function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}function e(a,b){if(!a)throw new Error(b||"assertion error")}function f(a){e(typeof a=="number"&&a>=0),this.serverRevision=a,this.state="synchronized"}var b=a.operational_transformation||require("./operational-transformation"),c={callMethodForState:function(a){var b=Array.prototype.slice.call(arguments,1);return this.states[this.state][a].apply(this,b)},transitionTo:function(a){var b=Array.prototype.slice.call(arguments,1);this.states[this.state].exit.apply(this,[]),this.states[this.state=a].enter.apply(this,b)}};return d(f.prototype,c),f.prototype.createOperation=function(){return new b.Operation(this.callMethodForState("newRevision"))},f.prototype.applyClient=function(a){return this.callMethodForState("applyClient",a)},f.prototype.applyServer=function(a){e(a.revision===this.serverRevision),this.callMethodForState("applyServer",a),this.serverRevision++},f.prototype.sendOperation=function(a){throw new Error("sendOperation must be defined in child class")},f.prototype.applyOperation=function(a){throw new Error("applyOperation must be defined in child class")},f.prototype.states={"synchronized":{enter:function(){},exit:function(){},applyClient:function(a){this.sendOperation(a),this.transitionTo("awaitingConfirm",a)},applyServer:function(a){this.applyOperation(a)},newRevision:function(){return this.serverRevision}},awaitingConfirm:{enter:function(a){this.outstanding=a},exit:function(){delete this.outstanding},applyClient:function(a){e(a.revision===this.serverRevision+1),this.transitionTo("awaitingWithBuffer",this.outstanding,a)},applyServer:function(a){if(a.id===this.outstanding.id)this.transitionTo("synchronized");else{var c=b.transform(this.outstanding,a);this.applyOperation(c[1]),this.outstanding=c[0]}},newRevision:function(){return this.serverRevision+1}},awaitingWithBuffer:{enter:function(a,b){this.outstanding=a,this.buffer=b},exit:function(){delete this.outstanding,delete this.buffer},applyClient:function(a){e(a.revision===this.serverRevision+2),this.buffer=b.compose(this.buffer,a)},applyServer:function(a){if(a.id===this.outstanding.id)this.sendOperation(this.buffer),this.transitionTo("awaitingConfirm",this.buffer);else{var c=b.transform(this.outstanding,a);this.outstanding=c[0];var d=c[1],e=b.transform(this.buffer,d);this.buffer=e[0],this.applyOperation(e[1])}},newRevision:function(){return this.serverRevision+2}}},{Client:f}}(this);typeof module=="object"&&(module.exports=ot_client);